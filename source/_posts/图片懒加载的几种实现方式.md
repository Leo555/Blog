---
title: 图片懒加载的几种实现方式
date: 2017-08-28 14:55:20
categories: JavaScript
tags:
- lazyload
- getBoundingClientRect
- IntersectionObserver
---

[demo地址](https://lz5z.com/lazyload)

## 懒加载原理

当图片位于浏览器 viewport 中时，动态设置 `<img>` 标签的 src 属性，浏览器会根据 src 属性发送请求加载图片。

首先不设置 src 属性，将图片真正的 url 放在另外一个属性 data-src 中，在图片即将进入浏览器可视区域之前，将 url 取出放到 src 中。


## 懒加载的关键

懒加载的关键是**如何判断图片处于浏览器可视范围内**，通常有三种方法：

方法一

通过对比屏幕可视窗口高度和浏览器滚动距离与元素相对文档顶部的距离之间的关系，判断元素是否可见。

<!--more-->

示意图如下：

<img src="/assets/img/lazyload.svg" alt="lazyload.svg">

代码如下：

```javascript
function isInSight(el) {
    const clientHeight = window.innerHeight // 获取屏幕可视窗口高度
    const scrollTop = document.body.scrollTop // 浏览器窗口顶部与文档顶部之间的距离
    // el.offsetTop 元素相对于文档顶部的距离 
    // +100是为了提前加载
    return el.offsetTop <= clientHeight + scrollTop + 100
}
```

方法二

通过 getBoundingClientRect() 获取图片相对于浏览器视窗的位置

示意图如下：

<img src="/assets/img/lazyload1.svg" alt="lazyload1.svg">

getBoundingClientRect() 方法返回一个 ClientRect 对象，里面包含元素的位置和大小的信息

```javascript
ClientRect {
	bottom: 596,
	height: 596,
	left: 0,
	right: 1920,
	top: 0,
	width: 1920
}
```

其中位置是相对于浏览器视图左上角而言。代码如下：

```javascript
function isInSight1(el) {
    const bound = el.getBoundingClientRect() 
    const clientHeight = window.innerHeight // 表示浏览器可视区域的高度
    // bound.top 表示图片到可视区域顶部距离
    // +100是为了提前加载
    return bound.top <= clientHeight + 100 
}
```

方法三

使用 IntersectionObserver API，观察元素是否可见。“可见”的本质是目标元素与 viewport 是否有交叉区，所以这个 API 叫做“交叉观察器”。

