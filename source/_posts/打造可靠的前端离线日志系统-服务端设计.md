---
title: 打造可靠的前端离线日志系统-服务端设计
date: 2019-03-19 22:49:34
categories: JavaScript
tags:
- IndexedDB
---

上篇文章介绍了 IndexedDB 的用法和前端离线日志的架构，本篇讲述离线日志系统后端接口如何设计。

后端主要做三件事

1. 告诉前端是否上报离线日志。
2. 获取前端上报的离线日志，并且存储在服务器上（存在文件中或者数据库里）
3. 给日志管理平台返回离线日志数据。


<!--more-->

为了方便理解，我精简了 badjs 中离线日志的代码，写了一个 [offline-log-server](https://github.com/Leo555/offline-log-server) 出来，用来讲解服务端 api 如何设计。


### 服务端设计

服务端一共设计有 4 个接口。

1. 增加上报监听的接口。

由于离线日志的特性，我们不能上报所有用户的离线日志，因此，我们在服务端设置一些监听条件，只有满足该条件的用户才上报离线日志。

对应代码中的 `/offline/addOfflineLog` 接口。

2. 检测是否上报离线日志的接口

服务端设置监听了，那客户端如何知道呢？因为没有使用 socket 协议，所以只能让客户端每次刷新的时候向服务端发送请求，来探测自己是否满足上报条件。

对应代码中的 `/offline/offlineAuto`  接口。


3. 数据上报接口

简单明了，就是为了把数据上报到服务端的接口。

对应代码中的 `/offline/offlineLog` 接口。

4. 数据展示接口

既然用户的离线日志成功上报了，总要有一个渠道来展示给开发者吧，于是就有了这个接口，用来将服务端的用户离线日志返回给前端。

对应代码中的 `/offline/showOfflineLog` 接口。


接口设计完毕，仅仅简单的四个接口就完成了一个离线日志平台。但是仅此就行了吗？

当然不行啦，我们还要考虑跨域上报，数据压缩，文件存储，接口安全，服务器并发，日志过期等等等等。

下面我就来简单介绍一下我们的解决方案。

### 跨域上报

因为我们要做的是一个离线日志平台，所以数据接收端是不知道有哪些域名需要上报的，因此就要解决跨域问题。而且离线日志上报的数据量又非常大，所以我们选择用 iframe post 数据的方式进行上报。

在 [wardjs-report](https://github.com/iv-web/wardjs-report/blob/master/src/log/index.js) 中可以看到 iframe 上报的方式，简单概括如下：

```javascript
reportOffline (logs) {
    let iframe = document.createElement('iframe')
    iframe.name = 'badjs_offline_' + (new Date() - 0)
    iframe.onload = function () {
        const form = document.createElement('form')
        form.style.display = 'none'
        form.target = iframe.name
        form.method = 'POST'
        form.action = url + '/offlineLog'
        const input = document.createElement('input')
        input.style.display = 'none'
        input.name = 'offline_log'
        input.value = logs

        iframe.contentDocument.body.appendChild(form)
        form.appendChild(input)
        form.submit()
        setTimeout(function () {
            document.body.removeChild(iframe)
            iframe = null
        }, 5000)

        iframe.onload = null
    }
    document.body.appendChild(iframe)
}
```









